# 小程序

## 小程序和 H5 的区别 / 为什么需要小程序

· 小程序的运行需要独立的容器，例如微信、抖音这些宿主环境（每种类型的小程序只能在其对应的宿主环境中访问，比如支付宝的小程序就不能在微信中获取），H5 的话是不区分环境的
· 小程序有些功能比 H5 多，比如开启摄像头、扫码、获取蓝牙等
· 小程序中可以允许有多个页面同时存在容器中，而 H5 只有一个页面，所以同样是从页面 a 跳转到页面 b，小程序的渲染速度会比 H5 快很多，但如果是页面内自己刷新，那么 H5 的效率是要高于小程序的
· 小程序是可以在没有网络的情况下打开的，而 H5 不行
· 小程序与 H5 的更新机制不同，H5 的更新总是会获取最新的（在没有设置强缓存的前提下），而小程序是可以允许使用旧版，然后在后台静默更新

## 微信小程序为什么要将渲染层（Webview）和逻辑层（JsCore）分开

因为 js 线程和渲染线程是互斥的，js 有时会调用 native 端的功能（比如开启摄像头）响应时间可能会比较久，此时渲染进程是被挂起的，如果两者在同一个页面中，这种情况下会引起页面卡顿

## JSBridge

桥接器，为 JS 提供调用 Native 功能的接口（比如开启摄像头、获取蓝牙），其核心是构建 Native 和非 Native 间消息通信的通道，并且这个通信的通道是双向的

### 实现方案

· 注入 API：将 Native 接口注入到 js 的上下文中（window），以达到 js 调用 Native 的目的

· 拦截 URL SCHEME：scheme 是 url 中的协议名，通过识别 scheme 判断当前是否为 jsBridge 请求（所以不能用 http 发请求，不识别，可以使用 iframe 的 src 属性）

#### 两者优劣

· 注入 API 使用简单，只要将 Native 接口注入到 js 上下文中就可以直接调用，相当于开箱即用，缺点是 window 对象是常驻与内存中的，当 Native Api 很多的时候，如果将这些 Api 全部挂载到 window，会显著提升当前系统内存，进而有可能造成页面卡顿

· 拦截 URL SCHEME 创建请求需要一定的耗时，调用同样的功能，相比于注入 API 的方式耗时会更长，但不会对当前上下文造成太大的内存损耗
